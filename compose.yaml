services:
  backup:
    build:
      context: ./src
      dockerfile: ../Dockerfile
    container_name: misskey-backup-go
    restart: always
    environment:
      TZ: Asia/Tokyo
    networks:
      - misskey-postgres
    env_file:
      - ./config/.env
    volumes:
      - mi-backups:/app/backups
      - ./config:/app/config:ro
    logging:
      options:
        max-size: 5m
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: '1g'
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 1m
      timeout: 10s
      retries: 3
      start_period: 30s

networks:
  misskey-postgres:
    external: true

volumes:
  mi-backups:
